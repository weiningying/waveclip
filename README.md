# WaveClip 🎵

一个简洁的音频剪辑 Web 应用，纯前端处理，无需上传文件到服务器。

![WaveClip Logo](wave.svg)

## 项目结构

```
/data/waveclip/
├── index.html      # 主应用（单文件，含 HTML/CSS/JS）
├── wave.svg        # Logo 图标（默认背景）
├── wave-light.svg  # 浅色模式 wave 背景
├── wave-dark.svg   # 深色模式 wave 背景
├── files.svg       # 文件夹图标
├── start.sh        # 启动脚本
├── Dockerfile      # Docker 配置
└── README.md       # 本斄档
```

## 技术架构

### 核心技术栈
- **纯前端**：HTML5 + CSS3 + Vanilla JavaScript
- **音频处理**：Web Audio API
- **MP3 编码**：lamejs（客户端编码）
- **静态服务器**：Python http.server

### 关键 DOM 元素 ID
| ID | 说明 |
|----|------|
| `waveformContainer` | 波形图容器 |
| `waveform` | Canvas 波形画布 |
| `waveformTimeline` | 时间刻度显示 |
| `waveformScrollbar` | 波形滚动条 |
| `startSlider` / `endSlider` | 左右剪辑控制杆 |
| `trimArea` | 选中范围高亮区域 |
| `playhead` | 播放头红线 |
| `audioPlayer` | 原生 audio 元素 |
| `themeToggle` | 主题切换按钮 |
| `wideModeToggle` | 宽屏模式切换按钮 |

### 全局状态变量
```javascript
let audioBuffer = null;      // Web Audio API 音频缓冲区
let audioContext = null;     // 音频上下文
let duration = 0;            // 音频总时长
let startTime = 0;           // 剪辑开始时间
let endTime = 0;             // 剪辑结束时间
let zoomLevel = 1;           // 波形缩放级别
let scrollOffset = 0;        // 波形滚动偏移
let playMode = 'selection';  // 'selection' | 'cursor'
let hasFileLoaded = false;   // 是否已加载文件
```

## 功能特性

### 🎼 音频处理
- **上传音频**：点击或拖拽上传（支持 MP3, WAV, AAC, FLAC 等格式）
- **可视化波形**：高清波形显示，支持窗口大小自适应
- **波形缩放**：鼠标滚轮放大缩小，最大 20 倍放大
- **导出 MP3**：支持 128/192/320 kbps 三种比特率选择，本地编码下载

### ✂️ 多种剪辑方式
- **拖拽控制杆**：拖动左右两侧红色控制杆调整范围
- **鼠标框选**：在波形图上按住鼠标左键拖选范围
  - 仅左键有效
  - 右键或 ESC 取消框选
- **设置起点/终点**：点击工具栏按钮，将当前播放头位置设为范围开始或结束
- **时间编辑**：点击"开始"或"结束"时间直接输入数值
- **快捷操作**：
  - 双击左侧控制杆 → 开始时间归零
  - 双击右侧控制杆 → 结束时间设为最大
  - 框选时按 ESC → 取消选择，恢复原范围
  - 框选时点击右键 → 取消选择，恢复原范围
  - Ctrl + 点击波形图 → 在点击位置设置起点
  - Ctrl + 右键波形图 → 在点击位置设置终点

### 🔍 波形导航
- **滚轮缩放**：在波形区域滚动鼠标滚轮放大/缩小
- **中键拖拽**：放大后按住鼠标中键平移波形视图
- **滚动条**：波形图上方显示滚动条，支持拖动和滚轮平移
- **时间刻度**：波形下方显示当前可见区域的时间刻度

### ▶️ 播放控制
- **播放模式**：
  - 鼠标在波形图上：从光标位置播放到文件结尾
  - 鼠标在波形图外：播放选中的剪辑范围
- **播放中点击**：点击波形图任意位置跳转到该处继续播放
- **播放控件**：暂停时可自由拖动进度条到任意位置
- **空格键**：播放/暂停切换

### 🎨 界面主题
- **三种主题**：浅色 / 深色 / 自适应（跟随系统）
- **宽屏模式**：切换宽屏/普通模式，宽屏模式提供更多编辑空间
- **背景动画**：Wave 背景缓慢移动（加载音频后自动停止，保持专注）
- **实时时间**：鼠标移动时显示浮动时间提示框
- **响应式设计**：适配不同屏幕尺寸

### ⌨️ 编辑操作
- **撤销/重做**：支持操作历史回溯（Ctrl+Z / Ctrl+Y）
- **删除选区**：删除选中的音频片段（Del 键）
- **全选**：快速选择整个音频范围
- **重置**：恢复原始音频文件

## 快速启动

### 方式一：使用浏览器打开index.html
直接用浏览器打开index.html即可使用。
若需要发布则需用到web服务器（如nginx）。

### 方式二：使用启动脚本

```bash
cd /data/waveclip
./start.sh        # 默认使用 8080 端口
./start.sh 3000   # 指定端口
```

### 方式三：手动启动

```bash
cd /data/waveclip
python3 -m http.server 8080 --bind 0.0.0.0
```

### 方式四：使用 Docker

```bash
# 本地构建运行
cd /data/waveclip
docker build -t waveclip .
docker run -p 8080:8080 waveclip

# 或使用已构建的镜像
docker run -p 8080:80 hub.paper1.cc/library/waveclip:v0.1
```

## 访问地址

启动后浏览器访问：

- **本机访问**: http://localhost:8080
- **局域网访问**: http://你的IP:8080

同一局域网内的手机、电脑都可以通过局域网地址访问使用。

## 使用指南

### 基本流程
1. 打开页面，点击或拖拽上传音频文件
2. 通过以下方式选择剪辑范围：
   - 拖动波形图两侧的红色控制杆
   - 在波形图上按住鼠标左键框选
   - 点击工具栏「设起点」/「设终点」按钮
   - 点击"开始"/"结束"时间输入具体数值
3. 点击「▶ 播放选中范围」预览片段
4. 点击「📥 导出 MP3」下载剪辑后的文件

### 快捷键
| 按键 | 功能 |
|------|------|
| `Space` | 播放/暂停 |
| `ESC` | 取消当前框选（恢复原有范围） |
| `右键` | 框选时取消选择 |
| `Del` | 删除选中范围 |
| `Ctrl + Z` | 撤销 |
| `Ctrl + Y` | 重做 |
| `A` / `D` | 放大时左右平移波形视图 |
| `Ctrl + 点击` | 在点击位置设置范围起点 |
| `Ctrl + 右键` | 在点击位置设置范围终点 |

### 界面控制

点击右上角的按钮可进行以下设置：

| 按钮 | 功能 |
|------|------|
| 宽屏图标 | 切换宽屏/普通模式 |
| 主题图标 | 切换浅色/深色/自适应模式 |

## 代码关键逻辑

### 波形缩放与平移
```javascript
// 滚轮缩放：根据鼠标位置计算缩放中心
// 中键拖拽：记录拖拽起点，计算偏移量
// 滚动条：根据缩放级别计算滑块宽度
```

### 框选功能
```javascript
// mousedown: 记录起点，仅左键(button === 0)
// mousemove: 超过5px阈值后显示预览
// mouseup: 应用选择
// ESC/右键: 取消并恢复原范围
```

### 播放控制
```javascript
// 选择范围模式：播放到 endTime 停止
// 光标模式：播放到文件结尾
// 播放中点击波形图：跳转到点击位置
// 暂停时可自由拖动进度条
```

### 主题系统
```javascript
// CSS 变量控制颜色
// auto 模式监听 prefers-color-scheme
// light/dark 模式强制覆盖
// 深色模式下 wave 背景使用更深的蓝色
```

## 浏览器支持

推荐使用以下现代浏览器：
- Chrome / Edge（推荐）
- Firefox
- Safari

## 注意事项

- 所有处理在浏览器本地完成，音频数据不会上传到服务器
- 大文件处理可能需要一些时间，请耐心等待
- 导出时会临时占用较多内存，建议处理单文件不超过 500MB
- 移动端使用时建议在 WiFi 环境下访问
- 加载音频后背景动画会自动停止，保持工作专注度

## 许可证

MIT License
